/*! game 31-05-2013 */
if(function(t){var e={};e.createMulticall=function(){var t=[],i=[],n=function(){for(var e=!1,n=0,s=t.length;s>n;++n)t[n]!==void 0&&(e=t[n].apply(i[n]||this,arguments)||e);return e};n.listeners=this,n.contexts=this,n.add=function(e,n){return t.push(e),i.push(n||null),this},n.remove=function(n,s){if(n||s){for(var r=-1,h=t.length;--h>=0;){var o=t[h],a=i[h];if(s&&a===s&&o===n){r=h;break}if(!s&&n===o){r=h;break}}r>-1&&(e.removeElement(t,h),e.removeElement(i,h))}else t.length=0,i.length=0;return this};for(var s=0,r=arguments.length-1;r>=s;++s)n.add(arguments[s]);return n},e.delimit=function(t){for(var e=""+t,i="",n=e.length;n>=0;n-=3){var s=n-3,r=0===i.length;if(0>=s){r||(i=","+i),i=e.substring(0,s+3)+i;break}r||(i=","+i),i=e.substr(s,3)+i}return i},e.removeElement=function(t,e){var i,n=0;if(Array.prototype.indexOf)n=t.indexOf(e);else for(n=0,i=t.length;i>n&&t[n]!==e;++n);t.splice(n,1)},e.shuffle=function(t,e){var i=[].concat(t);"function"!=typeof e&&(e=function(){return Math.random()});for(var n=i.length;--n>=1;){var s=Math.round(e()*n),r=i[n];i[n]=i[s],i[s]=r}return i},e.ease=function(t,i){var n=[];for(var s in i)if(i.hasOwnProperty(s)){var r=t[s],h=i[s],o=!1,a=!1;if(r!==h){if(+h===h)r=+r||0,h=+h;else if(""+h===h){try{var c=e.parseColor(h);c&&(h=c,r=e.parseColor(r)||[0,0,0,1],a=!0)}catch(l){a=!1}a||(o=!0)}else o=!0;var u={key:s,source:r,dest:h,isColor:a,isSet:o};n.push(u)}}return function(t,i){for(var s=0,r=n.length;r>s;++s){var h,o=n[s];h=o.isColor?e.mixColors(o.source,o.dest,i):o.isSet?1===i?o.dest:o.source:o.source*(1-i)+o.dest*i,t[o.key]=h}}},e.extendTo=function(t,e){function i(){}function n(){var i,n=this.super;return this.super=t,i=e.apply(this,arguments),n&&(this.super=n),i}return n.toString=function(){return e.toString.call(this)},i.prototype=t.prototype,i.prototype.constructor=t,n.prototype=new i,n.prototype.constructor=n,n},e.toRadix=function(t,e){for(var i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",n=[];t>0;){var s=t%e;t=Math.floor(t/e),n.unshift(i[s])}return n.join("")},e.isArray=function(t){return"[object Array]"==Object.prototype.toString.call(t)},e.mixColors=function(t,i,n){e.isArray(t)||(t=e.parseColor(t)),e.isArray(i)||(i=e.parseColor(i));for(var s=1-n,r=[],h=0;3>h;++h)r[h]=Math.min(255,Math.max(0,Math.round(t[h]*s+i[h]*n||0)));return r[h]=Math.min(1,Math.max(0,t[3]*s+i[3]*n||0)),"rgba("+r.join(",")+")"},e.parseColor=function(t){var e=[],i=!1;if(t=t.trim(),0===t.indexOf("rgba")?(t=t.substring(4),i=!0):0===t.indexOf("rgb")&&(t=t.substring(3),i=!0),i){t=t.replace("(",""),t=t.replace(")","");for(var n=t.split(","),s=0;n.length>s;++s)e[s]=parseFloat(n[s].trim())}else{if(0!==t.indexOf("#"))return!1;for(var n=t.match(/[0-9a-f]{2}/g),s=0;n.length>s;++s)e[s]=parseInt(n[s].trim(),16)}return 3===e.length&&e.push(1),e},e.applyDefaults=function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t.hasOwnProperty(i)||(t[i]=e[i]));return t};var i=function i(){return this._bindings={},this};i.prototype.on=function(t,i,n){this._bindings||(this._bindings={});var s=this._bindings[t]||e.createMulticall();return this._bindings[t]=s.add(i,n),this},i.prototype.once=function(t,i,n){function s(){return r.remove(s,n),i.apply(n||this,Array.prototype.slice.call(arguments,0))}this._bindings||(this._bindings={});var r=this._bindings[t]||e.createMulticall();return this._bindings[t]=r.add(s,n),this},i.prototype.off=function(t,e,i){this._bindings||(this._bindings={});var n=this._bindings[t];return n&&n.remove(e,i),this},i.prototype.trigger=function(t){this._bindings||(this._bindings={});var e=this._bindings[t],i=void 0;return e&&(i=e.call(this,arguments[1],arguments[2],arguments[3])),i},t.Utils=e,t.Events=i}("undefined"!=typeof exports?exports:window),function(t,e){for(var i=0,n=["ms","moz","webkit","o"],s=0;n.length>s&&!e.requestAnimationFrame;++s)e.requestAnimationFrame=e[n[s]+"RequestAnimationFrame"],e.cancelAnimationFrame=e[n[s]+"CancelAnimationFrame"]||e[n[s]+"CancelRequestAnimationFrame"];e.requestAnimationFrame||(e.requestAnimationFrame=function(t){var n=Date.now(),s=Math.max(0,2-(n-i)),r=e.setTimeout(function(){var e=Date.now();t(e)},0);return i=n+s,r},e.cancelAnimationFrame=function(t){clearTimeout(t)});var r=function r(t){return this._currentTime=0,this._callback=t,this};r.prototype.setCallback=function(t){this._callback=t},r.prototype.currentTime=function(){return this._currentTime},r.prototype.advance=function(t,e){this._currentTime+=t,this._callback(t,e)};var h=Utils.extendTo(r,function(t,e){return this.super(t),this._maxAdvance=e||h.DEFAULT_MAX_ADVANCE,this._running=!1,this._lastTimestamp=0,this._nextRequest=0,this});h.DEFAULT_MAX_ADVANCE=50,h.prototype.start=function(){this._running||(this._running=!0,this._nextRequest=e.requestAnimationFrame(this._nextFrame.bind(this)))},h.prototype.stop=function(){this._running=!1,e.cancelAnimationFrame(this._nextRequest),delete this._nextRequest},h.prototype._nextFrame=function(t){var i=this;if(this._lastTimestamp){var n=t-this._lastTimestamp;this._lastTimestamp=t,this.advance(Math.min(~~(n+.5),this._maxAdvance),function(){i._running&&(i._nextRequest=e.requestAnimationFrame(i._nextFrame.bind(i)))})}else this._lastTimestamp=t,this._running&&(this._nextRequest=e.requestAnimationFrame(this._nextFrame.bind(this)))},t.ClockTimer=h,t.Timer=r}("undefined"!=typeof exports?exports:window,"undefined"!=typeof window?window:exports),function(t){var e={};e.easeLinear=function(t){return t},e.easeCubic=function(t){return t*t*t},e.easeOutBounce=function(t){return 1/2.75>t?7.5625*t*t:2/2.75>t?7.5625*(t-=1.5/2.75)*t+.75:2.5/2.75>t?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},e.easeOut=function(t){return t-=1,t*t*t+1},e.easeIn=function(t){return t=1-t,1-t*t*t},e.easeOvershoot=function(t){return 2.5*-t*(t-1.4)},e.easeRebound=function(t){return 1-(2*t-1)*(2*t-1)},t.Easing=e}("undefined"!=typeof exports?exports:window),"undefined"!=typeof require){var fs=require("fs"),utils=require("./utils.js");Utils=utils.Utils}if(function(t){var e=function(){this._cache={}};e.prototype.spritesheet=function(t,e,i){for(var n=new Image,s=this,r=0;e.length>r;++r){var h=e[r],o=this._cache[h.url];o===void 0&&(o={},o.callback=Utils.createMulticall(),o.pending=!0,this._cache[h.url]=o),i&&o.callback.add(i)}n.addEventListener("load",function(){for(var t=0;e.length>t;++t){var i=e[t],r=s._cache[i.url];r.pending=!1,r.img=n,r.x=i.x,r.y=i.y,r.width=i.width,r.height=i.height,r.callback(r,i.url)}},!1),n.addEventListener("error",function(){for(var t=0;e.length>t;++t){n.pending=!1;var i=e[t],n=s._cache[i.url];n.pending=!1,n.error=!0,n.callback(null,i.url)}},!1),n.src=t},e.prototype.image=function(t,e){var i=this._cache[t];e=e||function(){},i===void 0&&(i={},i.callback=Utils.createMulticall(),this._cache[t]=i);var n=i.img;return i.pending?e&&i.callback.add(e):n===void 0?(n=new Image,i.img=n,e&&i.callback.add(e),fs!==void 0?fs.readFile(__dirname+t,function(e,s){i.pending=!1,e?(i.error=!0,i.callback(null,t)):(n.src=s,i.x=0,i.y=0,i.width=n.width,i.height=n.height,i.callback(i,t))}):(i.pending=!0,i.img=n,n.addEventListener("load",function(){i.pending=!1,i.x=0,i.y=0,i.width=n.width,i.height=n.height,i.callback(i,t)},!1),n.addEventListener("error",function(){i.pending=!1,i.error=!0,i.callback(null,t)},!1),n.src=t)):(i.error&&(i=null),e&&e(i,t)),i&&!i.pending?i:null},t.Resources=e}("undefined"!=typeof exports?exports:window),"undefined"!=typeof require){var utils=require("./utils.js");Utils=utils.Utils,Events=utils.Events}(function(t){var e=0,i=Utils.extendTo(Events,function(t,e,i){this.super(),e=e||{};var n=e.requires,s=e.defaults,r={},h={};for(var o in e)if(e.hasOwnProperty(o))if(0==o.indexOf("on")){var a=o.substring(2);r[a]=e[o]}else h[o]=e[o];return this._definition=e,this._name=t,this._objectListCache=[],this._objects={},this._objectsDirty=!0,this.engine=i,this.requires=n||[],this.defaults=s,this.listeners=r,this.methods=h,this});i.prototype.copy=function(t){return new i(this._name,this._definition,t)},i.prototype.applyBehaviour=function(t,e){var i=this.methods,n=this.listeners;this._objectsDirty=!0,this._objects[t.id]=t;for(var s in i)i.hasOwnProperty(s)&&!t.hasOwnProperty(s)&&(t[s]=i[s]);t._boundListeners=t._boundListeners||{};for(var r in n)n.hasOwnProperty(r)&&(t._boundListeners[r]||(t._boundListeners[r]=!0,t.on(r,n[r],t)));this.defaults&&Utils.applyDefaults(t,this.defaults);for(var h=0,o=this.requires.length;o>h;++h){var a=this.requires[h];t.hasBehaviour(a)||t.addBehaviour(a)}return"function"==typeof i.init&&e&&i.init.call(t),this},i.prototype.removeBehaviour=function(t){var e=this.methods,i=this.listeners;this._objectsDirty=!0,delete this._objects[t.id];for(var n in e)e.hasOwnProperty(n)&&t[n]===e[n]&&delete t[n];t._boundListeners=t._boundListeners||{};for(var s in i)i.hasOwnProperty(s)&&t._boundListeners[s]&&(t._boundListeners[s]=!1,t.off(s,i[s],t));return"function"==typeof e.destroy&&e.destroy.call(t),this},i.prototype.hookupChild=function(t){this._objects.hasOwnProperty(t.id)||(this._objectsDirty=!0,this._objects[t.id]=t)},i.prototype.unhookChild=function(t){this._objects.hasOwnProperty(t.id)&&(this._objectsDirty=!0,delete this._objects[t.id])},i.prototype.getObjects=function(){if(this._objectsDirty){this._objectsDirty=!1,this._objectListCache=[];for(var t in this._objects)this._objects.hasOwnProperty(t)&&this._objectListCache.push(this._objects[t])}return this._objectListCache},i.prototype.getName=function(){return this._name};var n=Utils.extendTo(Events,function(t,e,i){if(this.super(),this._behaviours={},this._children=[],this._updating=!1,this._pendingRemoves=[],this._pendingAdds=[],this.engine=i,this.active=!0,this.id=n.getNextId(),this.tag=null,e){var s={};for(var r in e)if(e.hasOwnProperty(r))if(0==r.indexOf("on")){var h=r.substring(2);this.on(h,e[r])}else s[r]=e[r],this[r]=e[r];this.savedDefaults=s}if(this.dx=this.dx||0,this.dy=this.dy||0,this.x=this.x||0,this.y=this.y||0,t)for(var o=0,a=t.length;a>o;++o)this.addBehaviour(t[o]);return this.on("attach",function(t){var e=this._children;if(e.length>0){e=[].concat(e);for(var i=0,n=e.length;n>i;++i){var s=e[i];s.engine!=t&&(s.engine=t,s.trigger("attach",t))}}}),this.on("subtick",function(t){var e=this._children;if(this._updating=!0,e.length>0){e=[].concat(e);for(var i=0,n=e.length;n>i;++i){var s=e[i];s.active&&s.trigger("subtick",t)}}this.trigger("tick",t),this._updating=!1;for(var i=0,n=this._pendingRemoves.length;n>i;++i)this.removeChild(this._pendingRemoves[i]);for(var i=0,n=this._pendingAdds.length;n>i;++i)this.addChild(this._pendingAdds[i]);this._pendingRemoves=[],this._pendingAdds=[],this.sortOnTick&&this._children.sort(function(t,e){return~~t.z-~~e.z})}),this.on("touchstart",function(t,e,i){if(!this.disabled){var n=this._children,s=!1;t-=~~this.x,e-=~~this.y,t/=this.scaleX||1,e/=this.scaleY||1,t-=~~this.offsetX,e-=~~this.offsetY;for(var r=n.length-1;r>=0;--r){var h=n[r];if(s=h.trigger("touchstart",t,e,i)||i.cancelled){i.cancelled=!0;break}}return s}}),this.on("touchmove",function(t,e,i){if(!this.disabled){var n=this._children,s=!1;t-=~~this.x,e-=~~this.y,t/=this.scaleX||1,e/=this.scaleY||1,t-=~~this.offsetX,e-=~~this.offsetY;for(var r=n.length-1;r>=0;--r){var h=n[r];if(s=h.trigger("touchmove",t,e,i)||i.cancelled){i.cancelled=!0;break}}return s}}),this.on("touchend",function(t,e,i){if(!this.disabled){var n=this._children,s=!1;t-=~~this.x,e-=~~this.y,t/=this.scaleX||1,e/=this.scaleY||1,t-=~~this.offsetX,e-=~~this.offsetY;for(var r=n.length-1;r>=0;--r){var h=n[r];if(s=h.trigger("touchend",t,e,i)||i.cancelled){i.cancelled=!0;break}}return s}}),this.on("subrender",function(t){game.breakOn===this.id&&(game.breakOn=game.breakOn);var e,i,n=this._children,s=!1,r=~~this.x,h=~~this.y,o=~~this.offsetX,a=~~this.offsetY,c=!1,l=!1;if(this.compositeOperation!==void 0&&(l=!0,i=t.globalCompositeOperation||"source-over",t.globalCompositeOperation=this.compositeOperation),this.alpha!==void 0&&1!==this.alpha&&(c=!0,e=t.globalAlpha,t.globalAlpha=this.alpha*e),(this.scaleX!==void 0&&1!==this.scaleX||this.scaleY!==void 0&&1!==this.scaleY||this.rotation!==void 0)&&(s||(s=!0,t.save()),t.translate(r+~~this.centerX,h+~~this.centerY),(this.scaleX!==void 0&&1!==this.scaleX||this.scaleY!==void 0&&1!==this.scaleY)&&t.scale(this.scaleX!==void 0?this.scaleX:1,this.scaleY!==void 0?this.scaleY:1),this.rotation&&t.rotate(this.rotation)),s&&t.translate(-r-~~this.centerX,-h-~~this.centerY),this.trigger("render",t),s&&t.translate(r,h),n.length>0){s?t.translate(o,a):(s=!0,t.save(),t.translate(r+o,h+a)),n=[].concat(n);for(var u=0,d=n.length;d>u;++u){var f=n[u];f.trigger("subrender",t)}}s&&t.restore(),l&&(t.globalCompositeOperation="source-over"),c&&(t.globalAlpha=e)}),this.on("gizmos",function(t){var e=this._children;if(e.length>0){var i=!1,n=~~this.x,s=~~this.y;~~this.centerX,~~this.centerY,(0!==~~n||0!==~~s)&&(i||(i=!0,t.save()),t.translate(n,s)),this.rotation&&(i||(i=!0,t.save()),t.rotate(this.rotation));for(var r=0,h=e.length;h>r;++r){var o=e[r];o.trigger("gizmos",t)}i&&t.restore()}}),this.on("gizmos",function(t){if(t.strokeStyle="#0000ff",t.lineWidth=1,this.x!==void 0&&this.y!==void 0&&this.width&&this.height){var e=this.x,i=this.y;this.rotation&&(t.save(),t.translate(e,i),t.rotate(this.rotation),e=0,i=0),this.centerX&&(e-=this.centerX),this.centerY&&(i-=this.centerY),t.strokeRect(e,i,this.width,this.height),this.rotation&&t.restore(),t.fillStyle="#0000ff",t.strokeStyle="#0000ff",t.lineWidth=2,t.beginPath(),t.arc(this.x,this.y,4,0,2*Math.PI,!1),t.fill(),t.beginPath(),t.moveTo(this.x,this.y),t.lineTo(this.x+this.dx/20,this.y+this.dy/20),t.closePath(),t.stroke(),t.closePath(),t.font="24px sans-serif",t.fillText(this.id,this.x-~~this.centerX+10,this.y-~~this.centerY+30)}}),e&&"function"==typeof e.init&&e.init.call(this),this});n.prototype.addModal=function(t){var e=this;e.disabled=!0,t.on("completed",function(){e.disabled=!1,t.remove()}),this.parent.addChild(t)},n.getNextId=function(){return Utils.toRadix(++e,36)},n.prototype.setTag=function(){return this.tag=tag,this},n.prototype.getTag=function(){return this.tag||this.id},n.prototype.addBehaviour=function(t){var e;e=""+t===t?this.engine.behaviour(t):t;var i=e.getName();return this._behaviours.hasOwnProperty(i)||(this._behaviours[i]=e,e.applyBehaviour(this,!0)),this},n.prototype.removeBehaviour=function(t){var e;return""+t!==t&&(t=t.getName()),this._behaviours.hasOwnProperty(t)&&(e=this._behaviours[t],e.removeBehaviour(this),delete this._behaviours[t]),this},n.prototype.hasBehaviour=function(t){return this._behaviours.hasOwnProperty(t)},n.prototype.getBehaviours=function(){var t=[];for(var e in this._behaviours)this._behaviours.hasOwnProperty(e)&&t.push(e);return t},n.prototype.remove=function(){this.parent&&this.parent.removeChild(this,!0)},n.prototype.removeAllChildren=function(){for(var t=[].concat(this._children),e=0;t.length>e;++e)t[e].remove()},n.prototype.bringToFront=function(){if(this.parent){var t=this.parent;t.removeChild(this,!1),t.addChild(this)}},n.prototype.addChild=function(t){if(t.parent&&t.parent.removeChild(t,!1),t.parent=this,this._children.push(t),!t.engine&&this.engine){for(var e in t._behaviours){var i=t._behaviours[e];i.hookupChild(t)}t.engine=this.engine,t.trigger("attach",this.engine)}return t.engine&&t.engine._addObject(t),this.trigger("childAdded",t),this},n.prototype.insertChild=function(t,e){return t.parent&&t.parent.removeChild(t,!1),t.parent=this,this._children.splice(e,0,t),!t.engine&&this.engine&&(t.engine=this.engine,t.trigger("attach",this.engine)),t.engine&&t.engine._addObject(t),this.trigger("childAdded",t),this},n.prototype.children=function(){return this._children},n.prototype.removeChild=function(t,e){if(t.parent===this){if(t.parent=null,Utils.removeElement(this._children,t),t.engine&&e){t.engine.removeObject(t);for(var i in t._behaviours){var n=t._behaviours[i];n.unhookChild(t)}}return this.trigger("childRemoved",t),this}},n.prototype.delay=function(t,e){function i(h){r||(s+=h,s>=t&&(r=!0,s=t),r&&(n.off("tick",i),e&&e.call(n)))}var n=this,s=0,r=!1;this.on("tick",i)},n.prototype.ease=function(t,e,i,n){function s(t){if(!o){h+=t,h>=e&&(o=!0,h=e);var c=h/e;c=Math.min(Math.max(c,0),1);var l=i(c);a(r,l),o&&(r.off("tick",s),n&&n.call(r))}}var r=this,h=0,o=!1,a=Utils.ease(this,t||this.savedDefaults);i=i||Easing.easeLinear,this.on("tick",s)},t.Behaviour=i,t.GameObject=n})("undefined"!=typeof exports?exports:window),function(t){var e=new Behaviour("mass",{ontick:function(t){this.dy+=this.engine.gravity*t,this.x+=this.dx*t,this.y+=this.dy*t},ongizmos:function(){},applyForce:function(t,e){this.dx+=t,this.dy+=e}});t.Mass=e}("undefined"!=typeof exports?exports:window),function(t){var e=new Behaviour("accelerometer",{ontick:function(){(this.engine.accelerationX||this.engine.accelerationY||this.engine.accelerationZ)&&(this.accelerationX=this.engine.accelerationX,this.accelerationY=this.engine.accelerationY,this.accelerationZ=this.engine.accelerationZ,this.smoothAccelerationX=this.engine.smoothAccelerationX,this.smoothAccelerationY=this.engine.smoothAccelerationY,this.smoothAccelerationZ=this.engine.smoothAccelerationZ)}}),i=new Behaviour("orientation",{ontick:function(){this.engine.orientation&&(this.orientation={alpha:this.engine.orientation.alpha,beta:this.engine.orientation.beta,gamma:this.engine.orientation.gamma})}});t.Accelerometer=e,t.Orientation=i}("undefined"!=typeof exports?exports:window),function(t){var e=80,i=new Behaviour("button",{requires:["sprite"],init:function(){this.updateState()},isInBounds:function(t,i,n){var s=this.x-~~this.centerX-(n?e:0),r=this.y-~~this.centerY-(n?e:0),h=t-s,o=i-r;return h>=0&&~~this.width+(n?2*e:0)>h&&o>=0&&~~this.height+(n?2*e:0)>o?!0:!1},updateState:function(){var t=this.wasDown;this.wasDown=this.isDown,this.url=this.isDown?this.pressedUrl:this.unpressedUrl,!!t!=!!this.isDown&&this.trigger("stateChanged",this.isDown)},ontouchstart:function(t,e){return this.disabled?void 0:(this.isInBounds(t,e)?(this.isDown=!0,this.touched=!0):(this.isDown=!1,this.touched=!1),this.updateState(),this.isDown)},ontouchmove:function(t,e){return this.disabled?void 0:(this.isInBounds(t,e,!0)?this.touched&&(this.isDown=!0):this.isDown=!1,this.updateState(),this.touched)},ontouchend:function(t,e){var i=this.touched;return this.touched=!1,this.isInBounds(t,e,!0)||(this.isDown=!1),this.isDown&&(this.isDown=!1,this.disabled||this.trigger("click",t,e)),this.updateState(),i}});t.GameButton=i}("undefined"!=typeof exports?exports:window),function(t){var e=new Behaviour("sprite",{defaults:{scaleX:1,scaleY:1},init:function(){var t=this;this.align&&this.on("loaded",function(){"center"===this.align&&(t.centerX=t.width/2,t.centerY=t.height/2)})},onrender:function(t){var e,i=this;!this.url||this.cachedImage&&this.cachedUrl===this.url||this.engine.resources.image(this.url,function(t,e){t&&(i.cachedImage=t,i.cachedUrl=e,i.width=i.width||t.width,i.height=i.height||t.height,i.srcwidth=t.width,i.srcheight=t.height,i.trigger("loaded"))}),this.cachedImage&&(e=this.cachedImage.img);var n=~~(this.x+.5),s=~~(this.y+.5);if(e){var r=this.width||(this.res?this.res.width:0),o=this.height||(this.res?this.res.height:0);this.crop?(w=this.width,h=this.height):(w=this.srcwidth,h=this.srcheight),t.drawImage(e,(this.offsetX||0)+this.cachedImage.x,(this.offsetY||0)+this.cachedImage.y,w,h,n-~~this.centerX,s-~~this.centerY,r,o)}}});t.Sprite=e}("undefined"!=typeof exports?exports:window),function(t){var e=new Behaviour("text",{defaults:{scaleX:1,scaleY:1,rotation:0,align:"left"},setText:function(t){this.text=t},getLetterUrl:function(t){return t+".png"},getKerning:function(){return~~this.kerning},transformLetter:function(t){switch(/[A-Z]/.test(t)&&(t="u"+t.toLowerCase()),t){case"!":return"exclamation";case":":return"colon";case".":return"period";case",":return"comma";case"-":return"hyphen";case" ":return"space";default:return t}},measure:function(){for(var t=0,e=0,i=!0,n=0,s=this.text.length;s>n;++n){var r=this.transformLetter(this.text[n]),h=this.getLetterUrl(r),o=this.engine.resources.image(h);o?(t+=o.width,n!==this.text.length-1&&(t+=this.getKerning(r)),e=Math.max(o.height,e)):(t+=this.getKerning(r),i=!1)}return i&&(this.measuredText=this.text),this.measuredWidth=t,this.height=e,this.trigger("textchanged"),{width:this.measuredWidth,height:this.height}},onrender:function(t){var e=~~(this.x+.5),i=~~(this.y+.5)-this.height,n=0;this.measuredText!==this.text&&this.align!==void 0&&this.measure();var s=e;if(""+this.text===this.text){"right"===this.align?(s=e-this.measuredWidth,this.centerX=this.measuredWidth):"center"===this.align&&(s=e-this.measuredWidth/2,this.centerX=this.measuredWidth/2),this.width=this.measuredWidth;for(var r=0,h=this.text.length;h>r;++r){var o=this.text[r];o=this.transformLetter(o);var a=this.engine.resources.image(this.getLetterUrl(o));a?(t.drawImage(a.img,a.x,a.y,a.width,a.height,s+n,i,a.width,a.height),n+=a.width,n+=this.getKerning(o)):n+=this.getKerning(o)}}}}),i=new Behaviour("canvas-text",{defaults:{scaleX:1,scaleY:1,rotation:0},setText:function(t){this.text=t},measure:function(t){!t&&document&&(t=document.createElement("canvas").getContext("2d")),this.font&&(t.font=this.font);var e=t.measureText(this.text);return this.measuredText=this.text,this.measuredWidth=e.width,this.trigger("textchanged"),{width:this.measuredWidth,height:this.height}},onrender:function(t){var e=~~(this.x+.5),i=~~(this.y+.5);this.font&&(t.font=this.font),this.color&&(t.fillStyle=this.color),this.measuredText!==this.text&&this.measure(t);var n=e;""+this.text===this.text&&("right"===this.align?(n=e-this.measuredWidth,this.centerX=this.measuredWidth):"center"===this.align&&(n=e-this.measuredWidth/2,this.centerX=this.measuredWidth/2),this.width=this.measuredWidth,this.strokeStyle&&(t.lineWidth=6,t.strokeStyle=this.strokeStyle,t.strokeText(this.text,n,i)),t.fillText(this.text,n,i))}});t.CanvasText=i,t.Text=e}("undefined"!=typeof exports?exports:window),function(t){function e(t){for(var e=t.getObjects(),i=0,n=e.length;n>i;++i){var s=e[i];s.collided=!1,s.collisions={}}for(var i=0,n=e.length;n>i;++i)for(var r=e[i],h=r.getBoundingBox(),o=i+1;n>o;++o){var s=e[o];if(s!==r&&r.collidesWith(s)&&s.collidesWith(r)&&!r.collisions.hasOwnProperty(s.id)){var a=s.getBoundingBox();(r.checkAABBIntersection(h,a)||r.checkAABBIntersection(a,h))&&(r.collisions[s.id]=s,s.collisions[r.id]=r)}}for(var i=0,n=e.length;n>i;++i){var s=e[i];for(var o in s.collisions)s.collided=!0,s.collisions.hasOwnProperty(o)&&s.trigger("collision",s.collisions[o])}}var i=new Behaviour("collider",{ongizmos:function(t){var e=this.getBoundingBox();this.collided?(t.strokeStyle="#ff0000",t.lineWidth=4):(t.strokeStyle="#00ff00",t.lineWidth=2),t.strokeRect(e.x,e.y,e.width,e.height)},checkAABBIntersection:function(t,e){for(var i=e.x,n=e.x+e.width,s=e.y,r=e.y+e.height,h=[[t.x,t.y],[t.x+t.width,t.y],[t.x,t.y+t.height],[t.x+t.width,t.y+t.height]],o=0;4>o;++o){var a=h[o],c=a[0],l=a[1];if(c>=i&&n>=c&&l>=s&&r>=l)return!0}return!1},getBoundingBox:function(){var t=~~this.x-~~this.centerX,e=~~this.y-~~this.centerY;return{x:t,y:e,width:this.width,height:this.height}},collidesWith:function(){return!0}});i.handleCollisions=e,t.Collider=i}("undefined"!=typeof exports?exports:window),function(t){var e={};e.fadeInOut=function(t,e){return function(i){var n=e.direction||"out",s=e.duration||.5,r=e.color||"#000",h=game.object({alpha:"in"===n?1:0,x:0,y:0,width:t.engine.view.width,height:t.engine.view.height,onrender:function(t){t.fillStyle=r,t.fillRect(this.x,this.y,this.width,this.height)}});h.ease({alpha:1-h.alpha},s,0===h.alpha?Easing.easeOut:Easing.easeIn,function(){i(),h.remove()}),t.addChild(h)}};var i=new Behaviour("scene",{onrender:function(t){this.background&&(t.fillStyle=this.background,t.fillRect(0,0,this.engine.view.width,this.engine.view.height))},onentering:function(t){function e(){i.trigger("enter"),t()}var i=this,n=this.transitionIn();n?n.call(this,e):e()},onleaving:function(t){function e(){i.trigger("leave"),t()}var i=this,n=this.transitionOut();n?n.call(this,e):e()},transitionIn:function(){return e.fadeInOut(this,{direction:"in",color:"#000",duration:.5})},transitionOut:function(){return e.fadeInOut(this,{direction:"out",color:"#000",duration:.5})},removeFromStack:function(){this.engine&&this.engine.removeScene(this)}});t.Scene=i,t.Transition=e}("undefined"!=typeof exports?exports:window),function(t){var e=200,i=new Behaviour("scroller",{defaults:{offsetX:0,offsetY:0},init:function(){this._lastDownEvent=null,this._lastTouchEvent=null,this._velocity=null},ontick:function(){var t=!1;this.contentWidth=0,this.contentHeight=0;for(var e=0;this._children.length>e;++e){var i=this._children[e],n=i.x-~~i.centerX+~~i.width,s=i.y-~~i.centerY+~~i.height;this.contentWidth=Math.max(this.contentWidth,n),this.contentHeight=Math.max(this.contentHeight,s)}this._targetOffsetX&&this.offsetX!==this._targetOffsetX&&(t=!0,this.offsetX=this.offsetX+(this._targetOffsetX-this.offsetX)/8),this._targetOffsetY&&this.offsetY!==this._targetOffsetY&&(t=!0,this.offsetY=this.offsetY+(this._targetOffsetY-this.offsetY)/8),t&&this.updateOffsets(this.offsetX,this.offsetY)},isInBounds:function(t,e){for(var i=this.x-~~this.centerX,n=this.y-~~this.centerY,s=this.parent;s;)i+=s.x,n+=s.y,s=s.parent;var r=t-i,h=e-n;return r>=0&&~~this.width>r&&h>=0&&~~this.height>h?!0:!1},boundedOffsets:function(t,e){var i=this.scaleX||1,n=this.scaleY||1;return t=Math.max((this.width-this.contentWidth)*i,t),e=Math.max((this.height-this.contentHeight)*n,e),t=Math.min(0,t),e=Math.min(0,e),[t,e]},updateOffsets:function(t,e){var i=this.boundedOffsets(t,e);this.offsetX=i[0],this.offsetY=i[1]},_markTouchEvent:function(t,e){var i=+new Date;if(this._lastTouchEvent){var n=i-this._lastTouchEvent.ts,s=this._lastTouchEvent.x-t,r=this._lastTouchEvent.y-e;n=n||1,n/=2;var h=this._velocity;this._velocity={x:s/n,y:r/n},h&&(this._velocity={x:(this._velocity.x+h.y)/2,y:(this._velocity.y+h.y)/2})}this._lastTouchEvent={x:t,y:e,ts:i}},ontouchstart:function(t,i,n){if(!n.cancelled){this._velocity=null,this._lastTouchEvent=null,this._markTouchEvent(t,i);var s=+new Date;if(this._lastDownEvent){var r=s-this._lastDownEvent;if(e>r)return this.trigger("doubletap",t,i),this._lastDownEvent=null,void 0}this._lastDownEvent=s,this.isInBounds(t,i)?(this.isDown=!0,this.touched=!0,this.initialX=t,this.initialY=i,this.initialOffsetX=~~this.offsetX,this.initialOffsetY=~~this.offsetY):(this.isDown=!1,this.touched=!1)}},ontouchmove:function(t,e,i){i.cancelled||(this._markTouchEvent(t,e),this.isDown&&this.updateOffsets(t-this.initialX+this.initialOffsetX,e-this.initialY+this.initialOffsetY))},ontouchend:function(t,e,i){if(!i.cancelled){if(this._markTouchEvent(t,e),this.isDown&&(this.updateOffsets(t-this.initialX+this.initialOffsetX,e-this.initialY+this.initialOffsetY),this._velocity)){var n=this.boundedOffsets(this.offsetX-100*this._velocity.x,this.offsetY-100*this._velocity.y);this._targetOffsetX=n[0],this._targetOffsetY=n[1]}this.touched=!1,this.isDown=!1}}});t.Scroller=i}("undefined"!=typeof exports?exports:window);var GameObject,Behaviour;if("undefined"!=typeof require){var utils=require("./utils.js"),resources=require("./resources.js"),timers=require("./timers.js"),gameObject=require("./game-object.js");Utils=utils.Utils,Events=utils.Events,Resources=resources.Resources,Timer=timers.Timer,ClockTimer=timers.ClockTimer,GameObject=gameObject.GameObject,Behaviour=gameObject.Behaviour}(function(t,e){var i=4,n=Utils.extendTo(GameObject,function(t){var s=this;this.super({},this),this.engine=this,this.accelerationHistory=[];var r,h,o,a=navigator?navigator.userAgent:"Android";if((o=/\bCPU.*OS (\d+(_\d+)?)/i.exec(a))?(r="ios",h=o[1].replace("_",".")):(o=/\bAndroid (\d+(\.\d+)?)/.exec(a))&&(r="android",h=o[1]),e.ondevicemotion=function(t){var e=t.accelerationIncludingGravity.x,n=-t.accelerationIncludingGravity.y,h=t.accelerationIncludingGravity.z;"android"===r&&(e=-e,n=-n),e=Math.min(1,Math.max(-1,e/10)),n=Math.min(1,Math.max(-1,n/10)),h=Math.min(1,Math.max(-1,h/10)),s.accelerationHistory.push({x:e,y:n,z:h}),s.accelerationHistory.length>i&&s.accelerationHistory.shift()},e.ondeviceorientation=function(t){s.orientation={alpha:t.alpha,beta:t.beta,gamma:t.gamma}},this.on("gizmos",function(t){var e=0;t.font="bold 26px sans-serif",t.fillStyle="#666",t.fillText(s.fps(),4,e+=30),t.font="bold 26px sans-serif",t.fillStyle="#ff4444",t.fillText([this.view.width,this.view.height,this._display.width,this._display.height].join(", "),4,e+=30)}),this.resources=new Resources,this.timer=t||new ClockTimer,this.timer.setCallback(function(t,e){s._tick(t,e)}),this.activeScene=null,this._sceneHistory=[],this._display={width:960,height:640},this.view={scaleMode:n.ScaleMode.FillHeight,x:0,y:0,width:640,height:960},cards&&cards._&&cards._.bridge){var c=cards._.bridge("Browser");c&&c.forceRepaint&&(this.browser=c)}this.backgroundColor="#ffffff",this.touches=[],this.touch={},this.gravity=2800,this._objects={},this._behaviours={},this._fixedStep=null,this._skipThreshold=null,this._renderThreshold=null,this._timer=t,this._timestamp=0,this._remaining=0,this._lastRenderTime=0,this.debugging=!1,this._fps=-1,this._renderings=0,this._lastFpsUpdate=-1,this._updateTimes=[],this._renderTimes=[];for(var l=0;n.DEFAULT_BEHAVIOURS.length>l;++l){var u=n.DEFAULT_BEHAVIOURS[l];this.behaviour(u._name,u._definition,this)}this.on("tick",function(){function t(t,e){for(var i=t[t.length-1][e],n=0;t.length>n;++n)i=(t[n][e]+i)/2;return i}if(s.accelerationHistory.length>0){var e=s.accelerationHistory[s.accelerationHistory.length-1];s.accelerationX=e.x,s.accelerationY=e.y,s.accelerationZ=e.z;var i=t(s.accelerationHistory,"x"),n=t(s.accelerationHistory,"y"),r=t(s.accelerationHistory,"z");s.accelerationXPre=(i+(s.accelerationXPre?s.accelerationXPre:0))/2,s.accelerationYPre=(n+(s.accelerationYPre?s.accelerationYPre:0))/2,s.accelerationZPre=(r+(s.accelerationZPre?s.accelerationZPre:0))/2,s.smoothAccelerationX=s.accelerationXPre,s.smoothAccelerationY=s.accelerationYPre,s.smoothAccelerationZ=s.accelerationZPre}var h=s.touch,o={};o.cancelled=!1,!h.wasDown&&h.isDown?h.wasDown=!0:h.wasDown&&h.isDown?s.trigger("touchmove",h.x,h.y,o):h.wasDown&&!h.isDown&&(h.wasDown=!1,s.trigger("touchend",h.x,h.y,o))})});n.prototype.removeScene=function(t){for(var e=0;this._sceneHistory.length>e;++e)if(this._sceneHistory[e]===t){this._sceneHistory.splice(e,1);break}},n.prototype.backScene=function(){var t=this._sceneHistory.pop();this.changeScene(t,!0)},n.prototype.changeScene=function(t,e){function i(i){s&&(s.remove(),(!e||i!==void 0&&!i)&&n._sceneHistory.push(s)),n.addChild(t),n.activeScene=t,t.trigger("entering",function(){})}var n=this,s=this.activeScene;s?s.trigger("leaving",i):i()},n.ScaleMode={Fixed:"fixed",Center:"center",Fill:"fill",FillWidth:"fill-width",FillHeight:"fill-height"},n.FPS_60=1e3/60/1e3,n.FPS_30=1e3/30/1e3,n.FPS_10=.1,n.prototype.updateDisplay=function(t,e){var i=this._display.width;this._display.height,this._display.width=t,this._display.height=e,(this._display.width!==i||this._display.height!==e)&&(this._display.changed=!0,this._fixViewSize())},n.prototype.fps=function(){return Math.round(this._fps)},n.prototype.setCanvas=function(t){function e(e){var i=e.clientX,n=e.clientY;return i=o.view.width*i/t.clientWidth,n=o.view.height*n/t.clientHeight,[i,n]}function i(t){var i=t.changedTouches,n=e(i?i[0]:t),s=n[0],r=n[1];return[s,r]}function n(t,i,n){var s=t.changedTouches;if(s)for(var r=0;s.length>r;++r){var h={},a=s[r];if(a)if(i){var c=e(a);h.x=c[0],h.y=c[1],h.isDown=i,h.clicked=n,o.touches[r]=h}else o.touches[r]=null}}function s(t){var e=i(t.changedTouches?t.changedTouches[0]:t),s={};return o.touch.x=e[0],o.touch.y=e[1],o.touch.isDown=!0,o.touch.wasDown=!1,o.touch.clicked=!0,3===t.touches.length&&(o.touch.trippleTapped=!0,o.debugging=!o.debugging),n(t,!0,!0),t.preventDefault(),s.cancelled=!1,o.trigger("touchstart",o.touch.x,o.touch.y,s),!1}function r(t){var e=i(t.changedTouches?t.changedTouches[0]:t);return o.touch.x=e[0],o.touch.y=e[1],o.touch.wasDown=!0,n(t,!0,!1),t.preventDefault(),!1}function h(t){var e=i(t.changedTouches?t.changedTouches[0]:t);
return o.touch.x=e[0],o.touch.y=e[1],o.touch.isDown=!1,n(t,!1,!1),o._lastX=-1,o._lastY=-1,t.preventDefault(),!1}var o=this;this.canvas=t,this.context=this.canvas.getContext("2d"),this._display.changed=!0,t.addEventListener("touchstart",s,!1),t.addEventListener("touchmove",r,!1),t.addEventListener("touchend",h,!1)},n.prototype.setSize=function(t,e){this.view.width=t,this.view.height=e,this._display.changed=!0},n.prototype._fixViewSize=function(){if(this._display.changed){switch(this._display.changed=!1,this.view.scaleMode){case n.ScaleMode.Fixed:break;case n.ScaleMode.Center:this.view.xoffset=Math.round((this._display.width-this.view.width)/2),this.view.yoffset=Math.round((this._display.height-this.view.height)/2);break;case n.ScaleMode.Fill:this.view.xoffset=0,this.view.yoffset=0,this.view.width=this._display.width,this.view.height=this._display.height;break;case n.ScaleMode.FillWidth:this.view.xoffset=0,this.view.yoffset=0,this.view.width=Math.round(this._display.width*this.view.height/this._display.height);break;case n.ScaleMode.FillHeight:this.view.xoffset=0,this.view.yoffset=0,this.view.height=Math.round(this._display.height*this.view.width/this._display.width)}this.canvas.width=this.view.width,this.canvas.height=this.view.height,this.trigger("resize",this.view.width,this.view.height),this._isReady||(this._isReady=!0,this.trigger("ready"))}},n.prototype.ready=function(t){this._isReady?t.call(this):this.once("ready",t)},n.prototype._tick=function(t,e){var i,n=this,s=Date.now(),r=!1;if(t*=n.multiplier||1,void 0!==typeof this.canvas&&n.updateDisplay(this.canvas.clientWidth,this.canvas.clientHeight),n._fixedStep)for(n._remaining+=t,2>Math.abs(n._remaining-n._fixedStep)&&(n._remaining=n._fixedStep),n._remaining>100&&(n._remaining=100);n._remaining>=n._fixedStep;)n._timestamp+=n._fixedStep/1e3,r=!0,n.trigger("subtick",n._fixedStep/1e3,n._timestamp),n._remaining-=n._fixedStep;else n._remaining+=t,t=n._remaining/1e3,n._remaining=0,n._timestamp+=t,r=!0,n.trigger("subtick",t,n._timestamp);if(i=Date.now(),r&&(n._updateTimes.unshift(i-s),n._updateTimes.length>=10&&n._updateTimes.pop()),r&&n.context){n._render(n.context);var h=+new Date;if(h-n._lastFpsUpdate>1e3){var o=n._renderings;0>n._fps&&(n._fps=o),n._fps=(4*o+n._fps)/5,n._renderings=0,n._lastFpsUpdate=h}this.hasForceRepaint&&this.browser.forceRepaint(),e()}else e()},n.prototype._render=function(t){var e,i=Date.now();this._lastRenderTime=this._timestamp,t.setTransform(1,0,0,1,0,0),t.fillStyle=this.background,t.fillRect(0,0,this.view.width,this.view.height),this.trigger("subrender",t),++this._renderings,e=Date.now(),this._renderTimes.unshift(e-i),this._renderTimes.length>=10&&this._renderTimes.pop(),this.debugging&&(t.setTransform(1,0,0,1,0,0),this.trigger("gizmos",t))},n.prototype.object=function(t){var e=Array.prototype.slice.call(arguments,0);if(e.length>0){var i=e[e.length-1];i instanceof Behaviour||""+i===i?t=null:(t=i,e.pop())}var n=new GameObject(e,t,this);return this._addObject(n),n.trigger("attach",this),n},n.prototype.behaviour=function(t,e){if(this._behaviours.hasOwnProperty(t))return this._behaviours[t];var i=new Behaviour(t,e,this);return this._behaviours[t]=i,i},n.prototype.start=function(){this.timer.start()},n.prototype.getObject=function(t){return this._objects[t]},n.prototype._addObject=function(t){var e=!this._objects.hasOwnProperty(t.id);if(this._objects[t.id]=t,e){var i=t._behaviours;for(var n in i)i.hasOwnProperty(n)&&i[n].applyBehaviour(t)}},n.prototype.removeObject=function(t){delete this._objects[t.id];var e=t._behaviours;for(var i in e)e.hasOwnProperty(i)&&e[i].removeBehaviour(t)},t.Game=n,t.GameObject=GameObject,t.Behaviour=Behaviour})("undefined"!=typeof exports?exports:window,"undefined"!=typeof window?window:exports),Game.DEFAULT_BEHAVIOURS=[Sprite,CanvasText,Text,Mass,Collider,Accelerometer,Orientation,Scene,Scroller,GameButton];